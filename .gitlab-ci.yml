stages:
    - Pipeline_Scan
    - Pipeline_Scan_with_Policy
    - Policy_Scan

Pipeline Scan Static Analysis:
    image: veracode/pipeline-scan:latest
    stage: Pipeline_Scan
    # only:
    #     - developent
    script:
        - zip -r nodegoat.zip ./
        - java -jar /opt/veracode/pipeline-scan.jar 
            -vid ${VERACODE_API_ID} 
            -vkey ${VERACODE_API_KEY} 
            --file nodegoat.zip 
            --issue_details true 
            --gl_issue_generation true 
            -jf results.json 2>&1 | tee pipeline_scan_text_output.txt
    artifacts:
        paths:
            - results.json
            - pipeline_scan_text_output.txt
        when: always
        name: "veracode-pipeline-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA"
    allow_failure: true

Pipeline Scan with Policy:
    image: openjdk:11-jre
    stage: Pipeline_Scan_with_Policy
    # only:
    #     - development
    before_script:
        - curl -sSO https://downloads.veracode.com/securityscan/pipeline-scan-LATEST.zip
        - unzip pipeline-scan-LATEST.zip
    script:
        - zip -r nodegoat.zip ./
        - java -jar pipeline-scan.jar -vid ${VERACODE_API_ID} -vkey ${VERACODE_API_KEY} --request_policy "nodegoat"
        - java -jar pipeline-scan.jar -vid ${VERACODE_API_ID} -vkey ${VERACODE_API_KEY} --file nodegoat.zip -pf nodegoat.json
    artifacts:
        paths:
            - pipeline_with_policy_results.json
    allow_failure: true


Policy Scan Static Analysis:
    image: veracode/api-wrapper-java
    stage: Policy_Scan
    # only:
        # - master
        # - development
    script:
        - zip -r nodegoat.zip ./
        - java -jar /opt/veracode/api-wrapper.jar 
          -vid ${VERACODE_API_ID} 
          -vkey ${VERACODE_API_KEY} 
          -action UploadAndScan 
          -appname "nodegoat" 
          -createprofile true 
          -autoscan true 
          -filepath nodegoat.zip 
          -version "Job ${CI_JOB_ID} in pipeline ${CI_PIPELINE_ID}" 
          -scantimeout 15 2>&1 | tee policy_scan_output.txt
    artifacts:
        paths:
            - policy_scan_output.txt
        when: always
        name: "veracode-POLICY-SCAN-$CI_COMMIT_REF_NAME-$CI_COMMIT_SHORT_SHA"
    allow_failure: true
